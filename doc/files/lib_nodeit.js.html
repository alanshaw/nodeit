<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/nodeit.js - nodeit</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="nodeit"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/bridge.html">bridge</a></li>
            
                <li><a href="../classes/codemirror.html">codemirror</a></li>
            
                <li><a href="../classes/Nodeit.html">Nodeit</a></li>
            
                <li><a href="../classes/nodeit (module).html">nodeit (module)</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/nodeit.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
// TODO: ChromeTabs needs to become a module

var events = require(&quot;events&quot;)
  , inherits = require(&quot;inherits&quot;)
  , cmUtil = require(&quot;./util/codemirror&quot;)
  , bridge = require(&quot;./bridge&quot;)
  , async = require(&quot;async&quot;)

require(&quot;setimmediate&quot;)
require(&quot;codemirror&quot;)

/**
 * @class Nodeit
 * @constructor
 * @param {Object} [opts]
 */
function Nodeit (opts) {
  this.opts = opts || {}
  this.bridge = this.opts.bridge || bridge
  
  this.tabsEl = $(this.opts.tabsEl || &quot;#tabs&quot;)
  this.editorEl = $(this.opts.editorEl || &quot;#editor&quot;)
  this.editor = CodeMirror(this.editorEl[0], {
      lineNumbers: true,
      lineWrapping: true,
      autofocus: true,
      matchBrackets: true,
      indentWithTabs: false,
      smartIndent: true,
      tabSize: 2,
      indentUnit: 2,
      updateInterval: 500,
      dragAndDrop: true
    })
  this.docs = []
  
  chromeTabs.init({
    $shell: this.tabsEl,
    minWidth: 45,
    maxWidth: 160
  })
  
  this.tabsEl.bind(&quot;chromeTabRender&quot;, this.onTabChange.bind(this))
  
  $(window).resize(this.onWindowResize.bind(this)).resize()
  
  setImmediate(function () {
    this.emit(&quot;ready&quot;)
    this.bridge.ready()
  }.bind(this))
  
  this.log(&quot;nodeit ready&quot;)
}

/**
 * When nodeit is ready
 * @event ready
 */
/**
 * When a new document is opened
 * @event docNew
 * @param {CodeMirror.Doc} doc
 */
/**
 * When a document is opened
 * @event docOpen
 * @param {CodeMirror.Doc} doc
 */
/**
 * When a document is saved to disk, or whatever
 * @event docSave
 * @param {CodeMirror.Doc} doc
 */
/**
 * When a document is closed
 * @event docClose
 * @param {CodeMirror.Doc} doc
 */
/**
 * When the current document is swapped for another
 * @event docSwap
 * @param {CodeMirror.Doc} doc The newly current document
 * @param {CodeMirror.Doc} prev The previously current document
 */
inherits(Nodeit, events.EventEmitter)

/**
 * Set the nodeit bridge object
 * @method setBridge
 * @param bridge
 */
Nodeit.prototype.setBridge = function (bridge) {
  this.bridge = bridge
}

/**
 * Log a message to the bridge
 * @method log
 */
Nodeit.prototype.log = function () {
  this.bridge.log(Array.prototype.slice.call(arguments).join(&quot; &quot;))
}

/**
 * Get the number of open docs
 * @method count
 * @returns {int}
 */
Nodeit.prototype.count = function () {
  return this.docs.length
}

/**
 * Retrieve the CodeMirror editor instance
 * @method getEditor
 * @returns {CodeMirror}
 */
Nodeit.prototype.getEditor = function () {
  return this.editor
}

/**
 * Create a new file
 * @method neu
 * @async
 * @param {Function} [cb]
 */
Nodeit.prototype.neu = function (cb) {
  this.log(&quot;New file&quot;)
  
  cb = cb || function (er) {
    if (er) this.log(er)
  }.bind(this)
  
  var doc = CodeMirror.Doc(&quot;&quot;, null, 0)
  
  // Store some nodeit data on the document
  doc.nodeit = {
    path: &quot;&quot;,
    saved: false
  }
  
  doc.on(&quot;change&quot;, this.onDocChange.bind(this))
  
  chromeTabs.addNewTab(this.tabsEl, {
    title: &quot;untitled&quot;,
    data: {docId: doc.id}
  })
  
  this.docs.push(doc)
  this.editor.swapDoc(doc)
  
  cb(null, doc)
  
  this.emit(&quot;docNew&quot;, doc)
}

/**
 * Open a file
 * @method open
 * @async
 * @param {String} [path] Path to file. If no path, prompt the user to choose a file to open
 * @param {Function} [cb] Callback
 */
Nodeit.prototype.open = function (path, cb) {
  this.log(&quot;Open file&quot;, path)
  
  cb = cb || function (er) {
    if (er) this.log(er)
  }.bind(this)
  
  // Don&#x27;t open if already open, switch to open doc tab
  if (path) {
    var doc = this.findDocByPath(path)
    
    if (doc) {
      chromeTabs.setCurrentTab(this.tabsEl, this.findTabByDoc(doc))
      return cb(null, doc)
    }
  }
  
  this.bridge.open(path, function (er, path, contents) {
    if (er) return cb(er)
    
    cmUtil.loadMode(cmUtil.pathToMode(path), function (er, mode) {
      if (er) return cb(er)
      
      var doc = CodeMirror.Doc(contents, mode, 0)
      
      // Store some nodeit data on the document
      doc.nodeit = {
        path: path,
        saved: true
      }
      
      doc.on(&quot;change&quot;, this.onDocChange.bind(this))
      
      chromeTabs.addNewTab(this.tabsEl, {
        //favicon: &#x27;img/icon-doc.svg&#x27;,
        title: Nodeit.pathToTitle(path),
        value: contents,
        data: {docId: doc.id}
      })
      
      this.docs.push(doc)
      this.editor.swapDoc(doc)
      
      cb(null, doc)
      
      this.emit(&quot;docOpen&quot;, doc)
      
    }.bind(this))
  }.bind(this))
}

/**
 * Save the passed document to disk, or whatever. If no document passed, default to current document.
 * @method save
 * @async
 * @param {CodeMirror.Doc} [doc] Document to save
 * @param {Function} [cb] Callback
 */
Nodeit.prototype.save = function (doc, cb) {
  
  cb = cb || function (er) {
    if (er) this.log(er)
  }.bind(this)
  
  doc = doc || this.editor.getDoc()
  
  this.log(&quot;Save doc&quot;, doc.id)
  
  if (doc.nodeit.saved) {
    return cb(new Error(&quot;Already saved&quot;))
  }
  
  this.bridge.save(doc.nodeit.path, doc.getValue(), function (er, path) {
    if (er) return cb(er)
    
    this.log(&quot;Bridge save called back&quot;)
    
    doc.nodeit.path = path
    doc.nodeit.saved = true
    
    // Update tab title
    var tab = this.findTabByDoc(doc)
    
    // TODO: Tab might not exist anymore if called because of a close
    // this is because chromeTabs doesn&#x27;t ask whether a tab should close or not
    if (tab) {
      tab.removeClass(&quot;unsaved&quot;).find(&quot;.chrome-tab-title&quot;).text(Nodeit.pathToTitle(path))
    }
    
    // Update mode
    cmUtil.loadMode(cmUtil.pathToMode(path), function (er, mode) {
      this.editor.setOption(&quot;mode&quot;, mode)
    }.bind(this))
    
    cb(null, doc)
    
    this.emit(&quot;docSave&quot;, doc)
  }.bind(this))
}

/**
 * Close the passed document, prompting for save if changed. If no document passed, default to current document.
 * @method close
 * @async
 * @param {CodeMirror.Doc} [doc] Document to close
 * @param {Function} [cb] Callback
 */
Nodeit.prototype.close  = function (doc, cb) {
  
  cb = cb || function (er) {
    if (er) this.log(er)
  }.bind(this)
  
  doc = doc || this.editor.getDoc()
  
  this.log(&quot;Close doc&quot;, doc.id)
  
  async.series([
    // Prompt save doc if not saved
    function (cb) {
      if (doc.nodeit.saved) return cb()
      if (doc.nodeit.path == &quot;&quot; &amp;&amp; doc.getValue() == &quot;&quot;) return cb()
      if (!confirm(&quot;Save changes to &quot; + Nodeit.pathToTitle(doc.nodeit.path) + &quot;?&quot;)) return cb()
      this.save(doc, cb)
    }.bind(this),
    
    // Close doc via bridge
    function (cb) {
      this.log(doc.nodeit.saved ? &quot;Closing saved doc&quot; : &quot;Closing doc with unsaved changes&quot;)
      
      this.bridge.close(doc.nodeit.path, doc.getValue(), function (er) {
        if (er) return cb(er)
        
        this.log(&quot;Bridge close called back&quot;)
        
        this.docs = this.docs.reduce(function (docs, d) {
          if (d !== doc) docs.push(d)
          return docs
        }, [])
        
        var tab = this.findTabByDoc(doc)
        
        // chromeTabs might have already closed the tab if user clicked the x
        if (tab) {
          chromeTabs.closeTab(this.tabsEl, tab)
        }
        
        // Remove orphan doc from editor
        if (!this.docs.length) {
          this.editor.swapDoc(CodeMirror.Doc(&quot;&quot;, null, 0))
        }
        
        cb(null, doc)
        this.emit(&quot;docClose&quot;, doc)
        
      }.bind(this))
    }.bind(this)
  ], cb)
}

/**
 * Close all open documents
 * @method closeAll
 * @async
 * @param {Function} [cb]
 */
Nodeit.prototype.closeAll  = function (cb) {
  
  cb = cb || function (er) {
    if (er) this.log(er)
  }.bind(this)
  
  this.log(&quot;Close all&quot;)
  
  var closeTasks = this.docs.map(function (doc) {
    this.log(&quot;Creating close task for&quot;, doc.id)
    return function (cb) {
      this.close(doc, cb)
    }.bind(this)
  }, this)
  
  async.series(closeTasks, cb)
}

/**
 * Find an open CodeMirror document by ID
 * @method findDocById
 * @param id
 * @returns {CodeMirror.Doc}
 */
Nodeit.prototype.findDocById = function (id) {
  for (var i = 0, len = this.docs.length; i &lt; len; ++i) {
    if (this.docs[i].id == id) {
      return this.docs[i]
    }
  }
  return null
}

/**
 * Find an open CodeMirror document by path
 * @method findDocByPath
 * @param {String} path
 * @returns {CodeMirror.Doc}
 */
Nodeit.prototype.findDocByPath = function (path) {
  for (var i = 0, len = this.docs.length; i &lt; len; ++i) {
    if (this.docs[i].nodeit.path == path) {
      return this.docs[i]
    }
  }
  return null
}

/**
 * Given a document, find it&#x27;s tab
 * @method findTabByDoc
 * @param {CodeMirror.Doc} doc
 * @returns {jQuery}
 */
Nodeit.prototype.findTabByDoc = function (doc) {
  var tabs = this.tabsEl.find(&quot;.chrome-tab&quot;)
  
  for (var i = 0, len = tabs.length; i &lt; len; ++i) {
    var tab = $(tabs[i])
    
    if (tab.data(&quot;tabData&quot;).data.docId == doc.id) {
      return tab
    }
  }
  return null
}

/**
 * @method onTabChange
 * @private
 */
Nodeit.prototype.onTabChange = function () {
  var tab = this.tabsEl.find(&quot;.chrome-tab-current&quot;)
    , closedDoc = null
  
  // Did a tab get closed?
  this.docs.some(function (doc) {
    if (!this.findTabByDoc(doc)) {
      closedDoc = doc
      return true
    }
    return false
  }, this)
  
  // Deal with fallout from closed tab
  if (closedDoc) {
    this.log(&quot;Tab closed&quot;)
    
    // Close the doc that belongs to this tab
    this.close(closedDoc, function (er) {
      if (er) return this.log(&quot;Failed to close doc &quot; + closedDoc.id, er)
    }.bind(this))
  }
  
  if (!tab.length) {
    return // No tabs open yet
  }
  
  var data = tab.data(&quot;tabData&quot;).data
    , doc = this.findDocById(data.docId)
    , prev = this.editor.getDoc()

  if (doc &amp;&amp; doc != prev) {
    this.log(&quot;Doc swap&quot;, prev.id, &quot; -&gt; &quot;, doc.id)
    this.editor.swapDoc(doc)
    this.emit(&quot;docSwap&quot;, doc, prev)
  }
}

/**
 * @method onDocChange
 * @private
 * @param doc
 */
Nodeit.prototype.onDocChange = function (doc) { 
  doc.nodeit.saved = false
  this.findTabByDoc(doc).addClass(&quot;unsaved&quot;)
}

/**
 * @private
 */
Nodeit.prototype.onWindowResize = function () {
  this.editorEl.height($(window).height() - this.tabsEl.outerHeight())
}

/**
 * Convert a file path to a human readable title suitable for showing on a tab, for instance
 * @method pathToTitle
 * @satic
 * @param {String} path
 * @returns {String}
 */
Nodeit.pathToTitle = function (path) {
  if (!path) {
    return &quot;untitled&quot;
  }
  var parts = path.split(&quot;/&quot;)
  return parts[parts.length - 1]
}

/* chrome-tabs tweaks */

// Disable dblclick event
!function () {
  var setupEvents = chromeTabs.setupEvents
  chromeTabs.setupEvents = function ($shell) {
    var $tabs = setupEvents.call(chromeTabs, $shell)
    $shell.unbind(&#x27;dblclick&#x27;)
    return $tabs
  }
}()

/**
 * @class nodeit (module)
 * @static
 */
module.exports = {
  /**
   * Create and return a new Nodeit instance
   * @method create
   * @param [opts]
   * @returns {Nodeit}
   */
  create: function (opts) {
    return new Nodeit(opts)
  }
}


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
